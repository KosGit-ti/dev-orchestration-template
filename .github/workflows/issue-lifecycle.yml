name: Issue Lifecycle

# PR ãƒãƒ¼ã‚¸æ™‚ã«é–¢é€£ Issue ã‚’è‡ªå‹•æ¤œè¨¼ãƒ»Close ã™ã‚‹ã€‚
# PR æœ¬æ–‡ã® "Closes #XX" / "Resolves #XX" / "Fixes #XX" ã‚’è§£æã—ã€
# plan.md ã® Done ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã®æ•´åˆæ€§ã‚’ç›£æŸ»ã—ã¦ã‹ã‚‰ Close ã™ã‚‹ã€‚

on:
  pull_request:
    types: [closed]

permissions:
  issues: write
  contents: read
  pull-requests: read
  projects: write

jobs:
  close-issues:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Extract linked issues from PR body
        id: extract
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "=== PR #${PR_NUMBER} merged ==="

          # PR æœ¬æ–‡ã‹ã‚‰ Closes/Resolves/Fixes #XX ã‚’æŠ½å‡º
          ISSUES=$(echo "$PR_BODY" | grep -oiE '(close[sd]?|resolve[sd]?|fix(e[sd])?)\s+#[0-9]+' | grep -oE '#[0-9]+' | tr -d '#' | sort -un)

          if [ -z "$ISSUES" ]; then
            echo "PR æœ¬æ–‡ã« Closes/Resolves/Fixes #XX ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "issues=" >> "$GITHUB_OUTPUT"
            echo "has_issues=false" >> "$GITHUB_OUTPUT"
          else
            echo "å¯¾è±¡ Issue: $ISSUES"
            echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"
            echo "has_issues=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Audit â€” plan.md æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        if: steps.extract.outputs.has_issues == 'true'
        env:
          ISSUES: ${{ steps.extract.outputs.issues }}
        run: |
          echo "=== ç‹¬ç«‹ç›£æŸ»: plan.md ã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ==="
          WARNINGS=0

          for NUM in $ISSUES; do
            # plan.md ã® Done ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã« Issue ç•ªå·ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if grep -q "#${NUM}" docs/plan.md; then
              # Done ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã«ã‚ã‚‹ã‹ã€ã¾ãŸã¯ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã§å®Œäº†ãƒãƒ¼ã‚¯ã‹ç¢ºèª
              if grep -A 100 "^## Done" docs/plan.md | grep -q "#${NUM}"; then
                echo "âœ… #${NUM}: plan.md ã® Done ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜è¼‰æ¸ˆã¿"
              elif grep -q "#${NUM}" docs/plan.md; then
                echo "âš ï¸ #${NUM}: plan.md ã«è¨˜è¼‰ã‚ã‚‹ãŒ Done ã‚»ã‚¯ã‚·ãƒ§ãƒ³å¤–ã€‚æ‰‹å‹•ç¢ºèªæ¨å¥¨"
                WARNINGS=$((WARNINGS + 1))
              fi
            else
              echo "âš ï¸ #${NUM}: plan.md ã«è¨˜è¼‰ãªã—ã€‚Close ã¯ç¶šè¡Œã™ã‚‹ãŒæ‰‹å‹•ç¢ºèªæ¨å¥¨"
              WARNINGS=$((WARNINGS + 1))
            fi
          done

          if [ $WARNINGS -gt 0 ]; then
            echo "::warning::${WARNINGS} ä»¶ã®è­¦å‘Šã‚ã‚Šã€‚plan.md ã®æ›´æ–°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi

          echo "=== ç›£æŸ»å®Œäº† ==="

      - name: Audit â€” Issue çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        if: steps.extract.outputs.has_issues == 'true'
        env:
          ISSUES: ${{ steps.extract.outputs.issues }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== ç‹¬ç«‹ç›£æŸ»: Issue çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ ==="

          for NUM in $ISSUES; do
            STATE=$(gh issue view "$NUM" --json state --jq '.state')
            if [ "$STATE" = "CLOSED" ]; then
              echo "âœ… #${NUM}: æ—¢ã« Closed"
            elif [ "$STATE" = "OPEN" ]; then
              echo "ğŸ“‹ #${NUM}: Open â†’ Close å¯¾è±¡"
            else
              echo "âš ï¸ #${NUM}: ä¸æ˜ãªçŠ¶æ…‹ ($STATE)"
            fi
          done

          echo "=== ç›£æŸ»å®Œäº† ==="

      - name: Close linked issues
        if: steps.extract.outputs.has_issues == 'true'
        env:
          ISSUES: ${{ steps.extract.outputs.issues }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Issue Close å®Ÿè¡Œ ==="

          for NUM in $ISSUES; do
            STATE=$(gh issue view "$NUM" --json state --jq '.state')
            if [ "$STATE" = "OPEN" ]; then
              gh issue close "$NUM" \
                --comment "PR #${PR_NUMBER} ã®ãƒãƒ¼ã‚¸ã«ã‚ˆã‚Šè‡ªå‹• Closeã€‚issue-lifecycle ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹ã€‚"
              echo "âœ… #${NUM}: Closed"
            else
              echo "â­ï¸ #${NUM}: æ—¢ã« Closedã€ã‚¹ã‚­ãƒƒãƒ—"
            fi
          done

          echo "=== å®Œäº† ==="
